<?xml version="1.0" encoding="utf-8"?>
<diff>
    <add sel="/aiscript[@name='trade.find.free']/params">
        <param name="stxoutstation" default="null" type="internal" />
        <param name="stxoutdock" default="false" type="internal" />
    </add>

    <add sel="/aiscript[@name='trade.find.free']/attention/actions/do_elseif/do_if/do_all/do_if[2]" pos="before">
        <do_if value="@$stxoutstation">
            <find_sell_offer tradepartner="this.ship" seller="$stxoutstation" result="$selloffers" wares="$filteredwarebasket" multiple="true">
                <totalvolume min="$practicalminvolume" />
                <mintotalvolume max="$practicalfreevolume" />
                <relativeprice max="$maxrelprice" tradepartner="if this.ship.isplayerowned then this.ship else null" comment="a value less than 0 means the sellprice must be below average" />
            </find_sell_offer>

            <do_if value="not $selloffers.count">
                <debug_text text="'stredux: no sale offers from our station'" chance="$debugchance" />
            </do_if>
        </do_if>
    </add>

    <!-- Disable the idle movement runner -->
    <add sel="/aiscript[@name='trade.find.free']/attention/actions/do_if[@value='this.sector']" pos="before">
        <do_if value="not @$stxoutdock">
            <set_value name="$stxoutdock" exact="false" />
        </do_if>
    </add>
    <replace sel="/aiscript[@name='trade.find.free']/attention/actions/do_if[@value='this.sector']/@value">this.sector and not $stxoutdock</replace>
</diff>

<!-- $debugchance -->